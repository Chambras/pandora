# Guide: Generating a Go SDK from Swagger Data

> The Pandora tools are primarily intended to be run in automation, this guide is a temporary set of instructions on how to generate a Go SDK, needed until the full automation pipeline is published.

> If you've found a new bug or something that didn't generate as expected - please open an issue so we can track/diagnose it.

## Steps

1. Follow [the guide "Importing a new Resource Manager Service (or a new API Version for an existing Service)"](resource-manager-service-import.md) (waiting for the PR to be merged).
2. Once the Pull Request is merged (and the API Definitions have been generated) - update your `main` branch via `git pull`.
3. Ensure you have the Dependencies installed ([listed in the README](../README.md)).
4. Build and Run the Data API.
5. Build and Run the Go SDK Generator.
6. Embedding the SDK within the Terraform Provider.

---

### Build and Run the Data API

To Build and Run the Data API:

```sh
$ cd ./data
$ make tools
$ make build
$ make run
```

At which point the Data API will be running at `http://localhost:5000` and `https://localhost:5001` (using a self-signed certificate).

---

### Build and Run the Go SDK Generator 

> Note: the Go SDK Generator pulls data from the Data API, so this must be available first.

The Go SDK Generator can be built and run via:

```sh
$ cd ./tools/generator-go-sdk/
$ make tools
$ make build
$ make run
```

At the current time this outputs the Go SDK to a folder on your desktop (`~/Desktop/generated-sdk-dev`) - although this will change in the future. This folder can be safely deleted and regenerated as necessary.

This folder should match (for example):

```
$ tree -d
.
├── appconfiguration
│   ├── 2019-10-01
│   │   └── configurationstore
│   └── 2020-06-01
│       ├── configurationstores
│       ├── privateendpointconnections
│       └── privatelinkresources
├── eventhub
│   ├── 2017-04-01
│   │   ├── authorizationrulesdisasterrecoveryconfigs
│   │   ├── authorizationruleseventhubs
│   │   ├── authorizationrulesnamespaces
│   │   ├── checknameavailabilitydisasterrecoveryconfigs
│   │   ├── consumergroups
│   │   ├── disasterrecoveryconfigs
│   │   ├── eventhubs
│   │   ├── messagingplan
│   │   ├── namespaces
│   │   └── networkrulesets
...
```

Once the Go SDK has been generated the Go SDK Generator will terminate automatically - however you'll need to shut down the Data API manually (using Cmd/Control+C).

## Embedding this SDK within the Terraform Provider

As the current time we're embedding the generated Go SDK's within the Provider to enable us to diff this.

Prior to going any further, please send a PR with the changes highlighted above to the Pandora repository (and have that merged) so that this repository is up to date. For the moment, ensuring the PR titles start with `Data: ` would be helpful to be able to differentiate these from the other projects.

Longer term this SDK _may_ live in its own repository, we're not sure - for now copying/embedding this SDK is sufficient.

The Generated SDK's get copied from:

```
~/Desktop/generated-sdk-dev/{service}/{version}/{resources}
```

to the following path within the provider:

```
./azurerm/internal/services/eventhub/sdk/{version}/{resources}
```

See [an example here](https://github.com/hashicorp/terraform-provider-azurerm/blob/8b8b5710bb4576e58fdeceda1dbad811d8eb9ef8/internal/services/analysisservices/sdk).

Notably when using a Pandora SDK we don't need to generate the Resource ID Parsers within the AzureRM Provider, since these are instead located within the SDK.

In the interim it's worth updating the existing (generated) validation function to use the ID Parser within the generated SDK - and removing the ID Generator from `resourceids.go` within the Service Package.

### Notes

The SDK Generated by Pandora is based on, but differs from the Azure SDK for Go - where the Azure SDK will output a single SDK (for example `network`) for a given API version, which contains all of the Resources - Pandora SDK's split these into separate packages.

This means Pandora SDK's will, by design, have more small SDK's (where the Azure SDK would output a single large SDK) - which allows us to both avoid naming conflicts in Constants between Resources and makes diffing (and gradual upgrades) easier, amongst other things.

If you've found a new bug or something that didn't generate as expected - please [open an issue](https://github.com/hashicorp/pandora/issues/new/choose) so we can track/diagnose it.
